{% extends "base.html" %}

{% block title %}Configuraci贸n de Pasarela de Pago{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1>Configuraci贸n de Pasarela de Pago</h1>
        <div class="admin-actions">
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">Dashboard</a>
            <a href="{{ url_for('admin.logout') }}" class="btn btn-danger">Cerrar Sesi贸n</a>
        </div>
    </div>
    
    <div class="admin-nav">
        <a href="{{ url_for('admin.dashboard') }}" class="nav-link">Dashboard</a>
        <a href="{{ url_for('admin.courses_list') }}" class="nav-link">Cursos</a>
        <a href="{{ url_for('admin.buyers_list') }}" class="nav-link">Compradores</a>
        <a href="{{ url_for('admin.payment_gateway') }}" class="nav-link active">Pasarela de Pago</a>
    </div>
    
    <div class="admin-form-container">
        <div class="info-box">
            <p><strong>Nota:</strong> Configura aqu铆 las credenciales de Redsys para procesar los pagos de los cursos. Puedes obtener estas credenciales desde tu panel de administraci贸n de Redsys.</p>
            <p><strong>Importante:</strong> En modo test, usa las credenciales de prueba proporcionadas por Redsys. Para producci贸n, usa las credenciales reales.</p>
            
            <div style="margin-top: 20px; padding: 15px; background: #e8f4f8; border-left: 4px solid #2196F3; border-radius: 4px;">
                <h4 style="margin-top: 0; color: #1976D2;"> Datos de Prueba de RedSys (Entorno Test)</h4>
                <p style="margin-bottom: 10px;"><strong>Para usar el entorno de pruebas, configura estos valores:</strong></p>
                <ul style="margin-left: 20px; margin-bottom: 10px;">
                    <li><strong>C贸digo de Comercio:</strong> <code>999008881</code></li>
                    <li><strong>Terminal:</strong> <code>001</code></li>
                    <li><strong>Clave Secreta:</strong> <code>sq7HjrUOBfKmC576ILgskD5srU870gJ7</code></li>
                    <li><strong>Entorno:</strong> <code>test</code></li>
                </ul>
                <p style="margin-bottom: 10px;"><strong>Tarjetas de prueba:</strong></p>
                <ul style="margin-left: 20px; margin-bottom: 0;">
                    <li><strong>Autorizada:</strong> <code>4548810000000003</code> (Caducidad: 12/49, CVV: 123)</li>
                    <li><strong>Denegada:</strong> <code>1111111111111117</code> (Caducidad: 12/20)</li>
                </ul>
            </div>
        </div>
        
        <form method="POST" class="admin-form">
            {{ form.hidden_tag() }}
            
            <div class="form-group">
                <label for="gateway_name">Pasarela de Pago *</label>
                {{ form.gateway_name(class="form-control", readonly=true) }}
                <small>Redsys (configurado autom谩ticamente)</small>
                {% if form.gateway_name.errors %}
                    <div class="form-errors">
                        {% for error in form.gateway_name.errors %}
                            <span class="error">{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="merchant_code">C贸digo de Comercio (Merchant Code) *</label>
                {{ form.merchant_code(class="form-control") }}
                <small>C贸digo de comercio proporcionado por Redsys (m谩ximo 9 caracteres)</small>
                {% if form.merchant_code.errors %}
                    <div class="form-errors">
                        {% for error in form.merchant_code.errors %}
                            <span class="error">{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="terminal">Terminal *</label>
                {{ form.terminal(class="form-control") }}
                <small>N煤mero de terminal (normalmente 001, m谩ximo 3 caracteres)</small>
                {% if form.terminal.errors %}
                    <div class="form-errors">
                        {% for error in form.terminal.errors %}
                            <span class="error">{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="secret_key">Clave Secreta (Secret Key) *</label>
                {{ form.secret_key(class="form-control", type="password") }}
                <small>Clave secreta proporcionada por Redsys para firmar las transacciones (nunca la compartas)</small>
                {% if form.secret_key.errors %}
                    <div class="form-errors">
                        {% for error in form.secret_key.errors %}
                            <span class="error">{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="environment">Entorno *</label>
                {{ form.environment(class="form-control") }}
                <small>Selecciona "test" para pruebas o "production" para producci贸n</small>
                {% if form.environment.errors %}
                    <div class="form-errors">
                        {% for error in form.environment.errors %}
                            <span class="error">{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="public_base_url">URL Base P煤blica (Opcional)</label>
                {{ form.public_base_url(class="form-control") }}
                <small>URL p煤blica de tu sitio (ej: https://tudominio.com). Si est谩 vac铆o, se usar谩 la URL de la petici贸n actual. <strong>Importante:</strong> Usa esto cuando pruebes en local pero quieras que RedSys pueda hacer notificaciones a tu servidor p煤blico.</small>
                {% if form.public_base_url.errors %}
                    <div class="form-errors">
                        {% for error in form.public_base_url.errors %}
                            <span class="error">{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Guardar Configuraci贸n</button>
                <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">Cancelar</a>
            </div>
        </form>
        
        {% if config %}
        <div class="info-box" style="margin-top: 30px;">
            <h3>Configuraci贸n Actual</h3>
            <p><strong>Pasarela:</strong> {{ config.gateway_name|upper }}</p>
            <p><strong>C贸digo de Comercio:</strong> {{ config.merchant_code if config.merchant_code else 'No configurado' }}</p>
            <p><strong>Terminal:</strong> {{ config.terminal if config.terminal else 'No configurado' }}</p>
            <p><strong>Clave Secreta:</strong> {{ 'Configurada' if config.secret_key else 'No configurada' }}</p>
            <p><strong>Entorno:</strong> {{ config.environment|upper if config.environment else 'No configurado' }}</p>
            <p><strong>URL Base P煤blica:</strong> {{ config.public_base_url if config.public_base_url else 'No configurada (usar谩 URL de la petici贸n)' }}</p>
            <p><strong>ltima actualizaci贸n:</strong> {{ config.updated_at.strftime('%d/%m/%Y %H:%M') if config.updated_at else 'N/A' }}</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

